name: PR Build Check

on:
  pull_request:
    branches:
      - main
      - dev
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  # Check 1: Verify Go modules and Compilation explicitly
  # This provides faster feedback than waiting for the full Docker build
  go-build:
    name: Go Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server/proxy
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Verify Dependencies
        run: go mod verify

      - name: Build Binary
        env:
          GOOS: linux
        run: go build -v ./...

      - name: Run Go Tests
        run: go test -v ./...

  # Check 2: Full Docker Build (Dry Run)
  # This ensures the Dockerfile stages (including the Go build inside Alpine) work correctly
  docker-build:
    name: Docker Build (Dry Run)
    runs-on: ubuntu-latest
    needs: go-build # Wait for the fast check first
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false # Important: Do not push to registry
          tags: odac-check:pr-${{ github.event.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
